<input type="file" (change)="onFileChanged($event)" style="display:none;" #fileInput />

<app-popover>
  <div header>
    <h1 *ngIf="!recipeToEdit; else editRecipe" style="margin-bottom: 0;">Add Recipe</h1>
    <ng-template #editRecipe>
      <h1 style="margin-bottom: 0;">EDIT {{recipeToEdit.title}}</h1>
    </ng-template>
  </div>

  <div body>
    <form [formGroup]="recipeForm" *ngIf="recipeForm">
      <input type="text" formControlName="title" class="form-control" placeholder="Recipe Title" />
      <textarea type="text" formControlName="description" class="form-control"
        placeholder="Recipe Description"></textarea>

      <h4>Image</h4>
      <button type="button" class="btn btn-light" (click)="fileInput.click();">
        Select Image
      </button>
      <div *ngIf="uploadedImage" class="image recipe-section"
        [ngStyle]="{ 'background-image': 'url(' + uploadedImage + ')' }"
        style="height: 250px; background-position: center; background-size: cover;"></div>
      <div class="d-flex section-heading align-items-center">
        <h4>Ingredients</h4>
        <button type="button" class="btn btn-light ml-2" (click)="addIngredientSection();">
          Add Section
        </button>
      </div>
      <div formArrayName="ingredient_sections">
        <ng-container
          *ngFor="let section of recipeForm.get('ingredient_sections')['controls']; let sectionIndex = index;"
          [formGroupName]="sectionIndex">
          <div class="d-flex  mt-2">
            <div>
              <button type="button" class="btn btn-light mr-2" (click)="removeSection(sectionIndex)">
                <fa-icon icon="times"></fa-icon>
              </button>
            </div>
            <input type="text" formControlName="name" placeholder="Section Name" class="form-control">
          </div>
          <div formArrayName="ingredients">
            <ng-container *ngFor="let ingredient of section.get('ingredients')['controls']; let ingredientIndex = index"
              [formGroupName]="ingredientIndex">
              <div class="d-flex mt-2" style="margin-left: 25px;">

                <div>
                  <button type="button" class="btn btn-light mr-2" (click)="removeIngredient(section, ingredientIndex)">
                    <fa-icon icon="times"></fa-icon>
                  </button>
                </div>

                <input [typeaheadOptionsLimit]="7"
                  (typeaheadOnSelect)="onTypeAheadIngredient($event.item.id, section, ingredientIndex)"
                  (blur)="onBlurIngredient($event.target.value, section, ingredientIndex)" [typeahead]="ingredientList"
                  class="form-control ingredient-input" placeholder="ingredient" typeaheadOptionField="name"
                  formControlName="ingredientName" />

                <input *ngIf="checkIfIngredient(section, ingredientIndex)" (keydown.enter)="addIngredient(section);"
                  type="number" formControlName="quantity" placeholder="Quantity" class="form-control ml-2 quantity" />

                <select *ngIf="checkIfIngredient(section, ingredientIndex)" class="form-control ml-2 ingredient-input"
                  (keydown.enter)="addIngredient(section);" formControlName="unit_id">
                  <option *ngFor="let unit of ingredient.get('unitList').value;" [ngValue]="unit.id">
                    {{ unit.name }}</option>
                </select>

                <input *ngIf="checkIfIngredient(section, ingredientIndex)" type="text" formControlName="notes"
                  placeholder="Notes" (keydown.enter)="addIngredient(section);"
                  class="form-control ml-2 ingredient-input" />
              </div>

            </ng-container>
          </div>


          <button type="button" class="btn btn-light mt-2" (click)="addIngredient(section)" style="margin-left: 25px;">
            Add
          </button>
        </ng-container>
      </div>


      <div class="d-flex section-heading">
        <h4>Steps</h4>
      </div>
      <ng-container formArrayName="steps" *ngFor="let steps of recipeForm.get('steps')['controls']; let i = index">
        <div [formGroupName]="i" class="d-flex">
          <div>
            <button type="button" class="btn btn-light mr-2" (click)="removeStep(i)">
              <fa-icon icon="times"></fa-icon>
            </button>
          </div>
          <textarea type="text" formControlName="instruction" placeholder="Instructions"
            class="form-control"></textarea>
        </div>
      </ng-container>
      <button type="button" class="btn btn-light" (click)="addStep()">
        Add
      </button>
      <div>
        <button type="button" class="btn btn-success" (click)="submit()">Submit</button>
      </div>

    </form>
  </div>
</app-popover>